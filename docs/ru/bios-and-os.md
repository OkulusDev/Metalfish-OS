# BIOS и ОС | Документация Metalfish OS

## [Главная страница](./index.md)

Когда мы включаем компьютер, он должен каким-то образом загрузить операционную систему. Он может загрузить ее с дискеты, с флэшки, с жесткого диска или с каих-либо других носителей.
Среда, которую дает нам компьютер вне ОС, может предоставить нам не так уж и много. Например, мы имеем BIOS (англ. Basic Input/Output Software), набор програм которые изначально загружены в памят и инициализированы как только компьютер включается. БИОС предоставляет базовый контроль над важными девайсами компьютера: экран, клавиатура, жесткий диск.
Чтобы БИОСу загрузить ОС, ему нужно узнать, есть ли ОС на определенном носителе. Для этого он читает первые 512 байтов носителя которые называются загрузочным сектором (англ. boot sector) и если они кончаются магическим числов 0xaa55,то он загружает код бут сектора в память, а процессор его исполняет.

Чтобы дать понять BIOS, что на текущей флэшке, компакт диске или жестком диске расположена ОС, на этом носителе должен быть загрузочный сектор. BIOS узнает загрузочный сектор по "магическому числу" из 2-х байт, равное 0xaa55 (в шестнадцатеричной системе исчисления). Простейший загрузочный сектор в машинном коде выглядит так:

```bin
 		e9 fd ff 00 00 00 00 00 00 00 00 00 00 00 00 00
 		00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
	   *
 		00 00 00 00 00 00 00 00 00 00 00 00 00 00 55 aa
```

Как видим, последние 2 байта действительно являются "магическим числом". Первые 3 байта являются машинными инструкциями, которые запускают Бесконечный цикл, а остальное просто заполнено нулями т.к. наша программа должна быть размером ровно 512 байт.

Простейший загрузчик на ассембере для nasm реализован ниже:

```asm
						; Бесконечный цикл:
loop:					; Определяем метку "loop"

	jmp loop			; Инструкция "jmp" позволяет нам перейти к метке
						; "loop" (англ. jump - прыжок), т.е. создается
						; бесконечный цикл.

times 510-($-$$) db 0	; Инструкция "times" заставляет идущую после нее
						; команду выполняться опредленное количество раз, т.е.
						; times <кол-во раз> <команда>.
						; Токен $ высчитывает позицию начала текущей строки,
						; токен $$ - позицию начала текущей секции.
						; 510-($-$$) = 510-(2-0) = 508 байт. Чтобы лучше понять
						; как это работает, рекомендую посмотреть как программа
						; выглядит в машинном коде с помощью утилиты ghex.
						; Таким образом мы заполняем пространство нулями (db 0),
						; приводя нас к 510-му байту.
						; db расшифровывается как "declare bytes", т.е.
						; "объявить байты"

dw 0xaa55				; В последние два байта кладем "магическое число",
						; чтобы BIOS знал, что это загрузочный сектор
```
